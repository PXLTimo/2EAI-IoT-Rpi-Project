name: Bramj

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up QEMU + Buildx
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image
      - name: Build Docker image
        run: docker build -t bramj_builder .

      # 4️⃣ Compile inside Docker
      - name: Compile inside Docker
        run: |
          docker run --rm -v ${{ github.workspace }}:/work bramj_builder \
            bash -c "
              cd /work

              gcc -c pigpio/*.c
              ar rcs libpigpio.a *.o

              gcc main.c -L. -lpigpio -lpthread -o main
            "

           - name: Ensure SSH known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PI_HOST }} >> ~/.ssh/known_hosts

      - name: Upload main to Raspberry Pi
        run: |
          scp ./main ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }}:/home/${{ secrets.PI_USER }}/main

      - name: Restart program via tmux
        run: |
          ssh ${{ secrets.PI_USER }}@${{ secrets.PI_HOST }} << 'EOF'
            cd /home/${{ secrets.PI_USER }}
            chmod +x main
            tmux kill-session -t bramj || true
            tmux new -d -s bramj "./main"
          EOF
